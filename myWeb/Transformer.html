<html>
  <head>
    <title>Transformer</title>
    <style>
      #Gmap {
        width: 600px;
        height: 600px;
        float:right;
      }
    </style>
  </head>
  <script type="text/javascript"
  src="http://openspace.ordnancesurvey.co.uk/osmapapi/openspace.js?key=CE9B85538994100AE0405F0AC8601AFA">
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?callback=initGMap"
    async defer></script>
  <script type="text/javascript" src="testing.js">
  </script>
  <script type="text/javascript" src="gmaps.js">
  </script>
  <body>
  <div id="Gmap"></div>
  </body>
  <script type="text/javascript">
  initOSMap();

  var pixelList=[];
  var mapPointList = [];
  var lonlatList = [];
  function createCanvas(image){

    // create a new canvas element
    var myCanvas = document.createElement("canvas");
    var myCanvasContext = myCanvas.getContext("2d");

    var imgWidth=image.width;
    var imgHeight=image.height;
    var list=[];
    var queue=[];
    var largest;
    var maxLLength;
    var maxQLength;
    

    // set the width and height to the same as the image
    myCanvas.width= imgWidth;
    myCanvas.height = imgHeight;

    // draw the image
    myCanvasContext.drawImage(image,0,0);

    // get all the image data into an array
    var imageData = myCanvasContext.getImageData(0,0, imgWidth, imgHeight);

    /* 
    ------------------------------ PART 1------------------------------
    simple colout filtering, getting rid of colour that is not red
    regardless of size of pattern
    just simpliy going through all the pixels on the photo one by one
    */
    for (j=0; j<imageData.width; j++)
    {
      for (i=0; i<imageData.height; i++)
      {    
        // in canvas mat: RGBA
        // index: red, green, blue, alpha, red, green, blue, alpha..etc.
        var index=(i*4)*imageData.width+(j*4);
        if (largest == undefined)
          largest = index;
        else if (index > largest) {
          largest = index;
        }
        else;

        var R=imageData.data[index];
        var G=imageData.data[index+1];
        var B=imageData.data[index+2];
        var A=imageData.data[index+3];

        if (R >= 150 && G <= 100 && B <= 200 && B >= 90)
        {
          imageData.data[index]=255;
          imageData.data[index+1]=0;
          imageData.data[index+2]=0;
          imageData.data[index+3]=A;
        }

        else
        {
          // set the rest to black
          imageData.data[index+0]=0;        
          imageData.data[index+1]=0;
          imageData.data[index+2]=0;
          imageData.data[index+3]=A;          
        }     
      }
    } // end of PART 1: colout filtering
    //document.write(largest[0]);

    for (j=0; j<imageData.height; j++)
    {
      for (i=0; i<imageData.width; i++)
      {
        var index=(i*4)*imageData.width+(j*4); // 4 * (i * width + j)
        var R=imageData.data[index];
        var G=imageData.data[index+1];
        var B=imageData.data[index+2];
        var A=imageData.data[index+3];     

        if (R != 0 && B != 255)
        {
          list[list.length] = index;
          queue[queue.length] = index;
          var point;

          while (queue.length != 0)
          {
            point = queue[0]; // set the latest update as target point
            //document.write(point + " //R:" + imageData.data[point] + " G:" + imageData.data[point+1] + " B:" + imageData.data[point+2] + "//\t");
            //document.write(point-4*imageData.width-4 + "\t");

            if ((point-4*imageData.width-4) < 0 || (point-4*imageData.width-4) > largest+4);
              //document.write("Reject top left!\t");
            else if (imageData.data[point-4*imageData.width-4] == 255 
                    && imageData.data[point-4*imageData.width-4 + 2] == 0){
              queue[queue.length] = point-4*imageData.width-4;
              list[list.length] = point-4*imageData.width-4;
              imageData.data[point-4*imageData.width-4 +2] = 255;
              // document.write("//" + (point-4*imageData.width-4) + " R:" + imageData.data[point-4*imageData.width-4] + " G:" + imageData.data[point-4*imageData.width-4+1] + " B:" + imageData.data[point-4*imageData.width-4+2] + "//\t");
              // document.write(largest + "--" + (point-4*imageData.width-4));   
            }
                              
            // else if (imageData.data[point-4*imageData.width-4] == 255 
            //         && imageData.data[point-4*imageData.width-4 + 2] == 0) {
            //   queue[queue.length] = point-4*imageData.width-4;
            //   list[list.length] = point-4*imageData.width-4;
            //   imageData.data[point-4*imageData.width-4 +2] == 255;
            //   document.write("top left, ");   
            // }

            if ((point-4) < 0 || (point-4) > largest+4);
              //document.write("Reject left!\t"); 
            else if (imageData.data[point-4] == 255 
                    && imageData.data[point-4 + 2] == 0){
              queue[queue.length] = (point-4);
              list[list.length] = (point-4);
              imageData.data[point-4 +2] = 255;
              //document.write("left, ");  
            }
        
                     
            // else if (imageData.data[point-4] == 255 
            //        && imageData.data[point-4 + 2] == 0) {
            //   queue[queue.length] = point-4;
            //   list[list.length] = point-4;
            //   imageData.data[point-4 +2] == 255;
            //   document.write("left, ");  
            // }

            if ((point+4*imageData.width-4) < 0 || (point+4*imageData.width-4) > largest+4);
              //document.write("Reject down left!\t"); 
            else if (imageData.data[point+4*imageData.width-4] == 255 
                    && imageData.data[point+4*imageData.width-4 +2] == 0){
              queue[queue.length] = (point+4*imageData.width-4);
              list[list.length] = (point+4*imageData.width-4);
              imageData.data[point+4*imageData.width-4 +2] = 255;
              //document.write("down left, ");  
            }
                                  
            // else if (imageData.data[point+4*imageData.width-4] == 255 
            //         && imageData.data[point+4*imageData.width-4 +2] == 0) {
            //   queue[queue.length] = point+4*imageData.width-4;
            //   list[list.length] = point+4*imageData.width-4;
            //   imageData.data[point+4*imageData.width-4 +2] == 255;
            //   document.write("down left, ");  
            // }

            if ((point-4*imageData.width) < 0 || (point-4*imageData.width) > largest+4);
              //document.write("Reject top mid A!\t");                                           
            else if (imageData.data[point-4*imageData.width] == 255 
                    && imageData.data[point-4*imageData.width + 2] == 0) {
              queue[queue.length] = (point-4*imageData.width);
              list[list.length] = (point-4*imageData.width);
              imageData.data[point-4*imageData.width +2] = 255;
              //document.write("top mid, ");
            }  

            if ((point+4*imageData.width) < 0 || (point+4*imageData.width) > largest+4);
              //document.write("Reject down mid!\t");                                      
            else if (imageData.data[point+4*imageData.width] == 255 
                      && imageData.data[point+4*imageData.width+2] == 0) {
               queue[queue.length] = (point+4*imageData.width); // ATTENTION NEEDED!!!!!!
               list[list.length] = (point+4*imageData.width);
               imageData.data[(point+4*imageData.width) +2] = 255;
               // document.write("//" + (point+4*imageData.width) + " R:" + imageData.data[point+4*imageData.width] + " G:" + imageData.data[point+4*imageData.width+1] + " B:" + imageData.data[point+4*imageData.width+2] + "//\t");
               // document.write(" " + largest + "--" + (point+4*imageData.width));   
               //document.write("down mid " + point+4*imageData.width + ", ");  
             }  

            if (point-4*imageData.width+4 < 0 || point-4*imageData.width+4 > largest+4);
               //document.write("Reject top right!\t");                                          
            else if (imageData.data[point-4*imageData.width+4] == 255 
                     && imageData.data[point-4*imageData.width+4 + 2] == 0) {
               queue[queue.length] = point-4*imageData.width+4; // ATTENTION NEEDED!!!!!!
               list[list.length] = point-4*imageData.width+4;
               imageData.data[point-4*imageData.width+4 +2] = 255;
               //document.write("top right, ");  
            } 

            if (point+4 < 0 || point+4 > largest+4);
               //document.write("Reject right!\t");                         
            else if (imageData.data[point+4] == 255 
                     && imageData.data[point+4 + 2] == 0) {
               queue[queue.length] = point+4; // ATTENTION NEEDED!!!!!!
               list[list.length] = point+4;
               imageData.data[point+4 +2] = 255;
               //document.write("right, ");  
            } 

            if (point+4*imageData.width+4 < 0 || point+4*imageData.width+4 > largest+4);
               //document.write("Reject down right!\t");                                  
             else if (imageData.data[point+4*imageData.width+4] == 255
                     && imageData.data[point+4*imageData.width+4 + 2] == 0) {            
               queue[queue.length] = point+4*imageData.width+4; // ATTENTION NEEDED!!!!!!
               list[list.length] = point+4*imageData.width+4;
               imageData.data[point+4*imageData.width+4 +2] = 255;
               //document.write("down right, ");  
            } 
            if (maxQLength == undefined)
              maxQLength = queue.length;
            else if (queue.length > maxQLength)
              maxQLength = queue.length;
            else;
   
            queue.splice (0,1); 
            //document.write("queue length b: " + queue.length + "\t");      
  
          } // while (queue.length != 0) 

          //document.write("end list " + list.length + "\t");   
          if (maxLLength == undefined)
            maxLLength = list.length;
          else if (list.length > maxLLength)
            maxLLength = list.length;
          else;

          // for elements too large or too small, set as background colour
          if (list.length > 47) {
            for (var i = 0; i < list.length; i++) {
              imageData.data[list[i]]=0;
              imageData.data[list[i]+1]=0;
              imageData.data[list[i]+2]=0;
              //document.write("gg");
            }
            list=[];
          } // if
          else if (list.length < 4) {
            for (var i = 0; i < list.length; i++) {
              imageData.data[list[i]]=0;
              imageData.data[list[i]+1]=0;
              imageData.data[list[i]+2]=0;
              //document.write("gg");
            }
            list=[];
          } // elseif
          // marked as white colour for footpath element
          // TODO -- PART 3
          else {
            for (var i = 0; i < list.length; i++) {
              imageData.data[list[i]]=255;
              imageData.data[list[i]+1]=255;
              imageData.data[list[i]+2]=255;
              if (i==0){
                pixelList[pixelList.length] = (list[i]/4)+1;
                //document.write("head");
              }
              else if (i==(list.length-1)) {
                pixelList[pixelList.length] = (list[i]/4)+1;
                //document.write("tail");
              }
            }
            list=[];
          } 
        } // if
      } // for 
    } // for
    //document.write(pixelList.length + ": \n");
    //document.write(pixelList);
    //document.write("max index " + largest + "\t");
    //document.write("max queue length " + maxQLength + "\t");     
    //document.write("max list length " + maxLLength + "\t");     
    
    //Reject top mid!  Reject down mid! Reject top right!  Reject right!  Reject down right!
    // put the image data back into the canvas
    pixel2mapPoint();
    myCanvasContext.putImageData(imageData,0,0,0,0, imageData.height, imageData.width);

    // append it to the body
    document.body.appendChild(myCanvas);
  }

  function loadImage()
  {
    var img = new Image();
    //img.crossOrigin = 'anonymous';
    img.onload = function ()
    {
      createCanvas(img);
    }
    /*
    1Grid: 
    upLeft   = 399000,400000
    upRight  = 400000,400000
    downLeft = 399000,399000
    downLeft = 400000,399000
    */
    //img.src = '1Grid.png';
    img.src = '4Grids.png';
    //img.src = "Screen Shot 2016-02-24 at 4.12.51 pm.png";    
    //img.src = "Screen Shot 2016-02-25 at 10.53.04 pm.png";   
    //img.src = "Screen Shot 2016-02-26 at 8.41.20 pm.png";
  }

  function mapPoint2lonlat(point)
  {
    return point2lonlat(point);
  }

  function pixel2mapPoint()
  {
    for (i = 0; i<pixelList.length; i++)
    {
      var pixelNumber = pixelList[i];
      var mapPointX = pixelNumber%400*2 + 399000; // attention needed
      var mapPointY = (pixelNumber-(pixelNumber%400))/400*(-2) + 401000;  // attention needed 
      var mapPointXY = new OpenSpace.MapPoint(mapPointX, mapPointY);
      var lonlat = mapPoint2lonlat(mapPointXY);
      //document.write(lonlatList);
      lonlatList.push(lonlat);
    }
    plotLonlat2Gmap();
  }

  function plotLonlat2Gmap()
  {
    try{
        var mapDiv = document.getElementById('Gmap');
        var GMAP = new google.maps.Map(mapDiv, {
                  center: {lat: 53.496718204694, lng: -2.0014692557496},
                  zoom: 14
        });
        //document.write(lonlatList);
        for (i = 0; i<lonlatList.length; i=i+2)
        {
          var lon1 = lonlatList[i].lon;
          var lat1 = lonlatList[i].lat;
          var lon2 = lonlatList[i+1].lon;
          var lat2 = lonlatList[i+1].lat;
          var footpathCoordinates = [
            {lng: lon1, lat: lat1},
            {lng: lon2, lat: lat2}
            ];

          var footpathFragment = new google.maps.Polyline({
            path: footpathCoordinates,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
            });

          // Gmap.drawPolyline({
          //   path: footpathCoordinates,
          //   strokeColor: '#131540',
          //   strokeOpacity: 0.6,
          //   strokeWeight: 6
          // });
          footpathFragment.setMap(GMAP);
        }
      }
    catch(e){
      error(e, "plotLonlat2Gmap");
    }
  }


  </script>

  <body onload="loadImage()">
  </body>

</html>